node {
  def tsd = [:]
  env.GRADLE_HOME = '/home/ubuntu/.sdkman/candidates/gradle/current'
  env.GRADLE = '/home/ubuntu/.sdkman/candidates/gradle/current/bin/gradle -p LocalEGA-deploy-swarm'
  tsd.name = 'private'
  tsd.host = '158.37.63.36'
  tsd.user = 'ubuntu'
  tsd.password = 'password'
  tsd.allowAnyHosts = true
  
  def cega_lega = [:]
  cega_lega.name = 'public'
  cega_lega.host = '158.37.63.170'
  cega_lega.user = 'ubuntu'
  cega_lega.password = 'password'
  cega_lega.allowAnyHosts = true
    withCredentials([sshUserPrivateKey(credentialsId: '214dcd62-2e2f-4e9d-8cdd-bbc97c3172c7', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'userName')]) {
        tsd.user = userName
        tsd.identityFile = identity
      stage('Private clean') {
        sshCommand remote: tsd, command: "$GRADLE clean_all"
        sshCommand remote: tsd, command: "rm -rf LocalEGA-deploy-swarm"
      } 
      stage('Private bootstrap') {
        sshCommand remote: tsd, command: "git clone --single-branch --branch $env.BRANCH_NAME https://github.com/NBISweden/LocalEGA-deploy-swarm.git"
        sshCommand remote: tsd, command: "$GRADLE bootstrapPrivate"
      } 
      stage('Private deploy') {
        sshCommand remote: tsd, command: "$GRADLE deployPrivate"
      } 
      stage('Private post deploy') {
        sshCommand remote: tsd, command: "$GRADLE ls"
        sshCommand remote: tsd, command: "docker service logs lega-private_mediator-server"
        sshCommand remote: tsd, command: "docker service logs lega-private_ingest"
      } 
  }
//}
//node {
//  env.GRADLE_HOME = '/home/ubuntu/.sdkman/candidates/gradle/current'
//  env.GRADLE = '/home/ubuntu/.sdkman/candidates/gradle/current/bin/gradle -p LocalEGA-deploy-swarm'  
      stage('Public clean') {
    withCredentials([sshUserPrivateKey(credentialsId: 'a5a36700-13f7-4efb-a14b-549b7a3499bb', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'userName')]) {
        cega_lega.user = userName
        cega_lega.identityFile = identity
        sshCommand remote: cega_lega, command: "$GRADLE clean_all"
        sshCommand remote: cega_lega, command: "rm -rf LocalEGA-deploy-swarm"
        }
      } 
      stage('Public bootstrap') {
          withCredentials([sshUserPrivateKey(credentialsId: 'a5a36700-13f7-4efb-a14b-549b7a3499bb', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'userName')]) {
        cega_lega.user = userName
        cega_lega.identityFile = identity
        sshCommand remote: cega_lega, command: "git clone --single-branch --branch $env.BRANCH_NAME https://github.com/NBISweden/LocalEGA-deploy-swarm.git"
        sshCommand remote: cega_lega, command: "$GRADLE bootstrapPublic"
      } }
      stage('Public deploy ') {
          withCredentials([sshUserPrivateKey(credentialsId: 'a5a36700-13f7-4efb-a14b-549b7a3499bb', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'userName')]) {
        cega_lega.user = userName
        cega_lega.identityFile = identity
        sshCommand remote: cega_lega, command: "$GRADLE deployPublic"
      } }
      stage('Public post deploy') {
          withCredentials([sshUserPrivateKey(credentialsId: 'a5a36700-13f7-4efb-a14b-549b7a3499bb', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'userName')]) {
        cega_lega.user = userName
        cega_lega.identityFile = identity
        sshCommand remote: cega_lega, command: "$GRADLE ls"
        sshCommand remote: cega_lega, command: "docker service logs lega-public_mediator-client"
        sshCommand remote: cega_lega, command: "docker service logs lega-public_mq"
      } 
  }
}


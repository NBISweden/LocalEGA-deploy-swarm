import se.nbis.lega.deployment.*
import se.nbis.lega.deployment.lega.*

import java.util.stream.Collectors

task removeVolumes(type: RemoveVolumesTask) {
    setGroup "lega-public"

    setVolumes Arrays.stream(Volume.values()).map { v -> v.getName() }.collect(Collectors.toSet())
}

task removeNetworks(type: RemoveNetworksTask) {
    setGroup "lega-public"

    setNetworks Arrays.stream(Network.values()).map { v -> v.getName() }.collect(Collectors.toSet())
}

task clearConfiguration(type: ClearConfigurationTask) {
    setGroup "lega-public"

    setConfigs Arrays.stream(LegaPublicConfig.values()).map { c -> c.getName() }.collect(Collectors.toSet())
}

task createMQConfiguration(type: CreateMQConfigurationTask)

task createInboxConfiguration(type: CreateInboxConfigurationTask)

task createIngestConfiguration(type: CreateIngestConfigurationTask)

task createConfIni(type: CreateLegaPublicConfIniConfigurationTask)

task createConfiguration {
    setGroup "lega-public"

    dependsOn clearConfiguration, createConfIni
}

task createCEGANetwork() {
    setGroup "lega-public"

    doLast {
        exec {
            ignoreExitValue = true
            executable "docker"
            args "network", "create", "-d", "overlay", "cega_cega"
        }
    }
}

task createLEGAPrivateNetwork() {
    setGroup "lega-public"

    doLast {
        exec {
            ignoreExitValue = true
            executable "docker"
            args "network", "create", "-d", "overlay", "lega-private_lega-private"
        }
    }
}

task createLEGAPublicNetwork() {
    setGroup "lega-public"

    doLast {
        exec {
            ignoreExitValue = true
            executable "docker"
            args "network", "create", "-d", "overlay", "lega-public_lega-public"
        }
    }
}

task deployStack(type: DeployStackTask) {
    setGroup "lega-public"

    dependsOn createCEGANetwork
    dependsOn createLEGAPrivateNetwork
    dependsOn createLEGAPublicNetwork

    setComposeFile file("docker-stack.yml").absolutePath
    setStackName "lega-public"
    setEnvironment getTraceAsMap()
}

task removeStack(type: RemoveStackTask) {
    setGroup "lega-public"

    setStackName "lega-public"
}
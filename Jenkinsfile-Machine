pipeline {
  
  agent any
  
//  triggers {
//    cron('0 0 * * *')
//    upstream(upstreamProjects: 'LocalEGA Build Trigger')
//  }
  options { disableConcurrentBuilds() }
  environment {
    GIT_COMMIT_SHORT = sh(
                    script: "printf \$(git rev-parse --short ${GIT_COMMIT})${BUILD_NUMBER}",
                    returnStdout: true
            )
    LEGA_private_IP='158.39.75.163'
    LEGA_public_IP='158.39.75.126'
    CEGA_IP='158.39.75.136'
  }
  
  stages {
      stage('Tear down') {
        steps {
            sh '''
              gradle :cega:removeStack -Pmachine=cega-staging --stacktrace
              gradle :lega-private:removeStack -Pmachine=lega-private-staging --stacktrace
              gradle :lega-private:removeVolumes -Pmachine=lega-private-staging --stacktrace
              gradle :lega-public:removeStack -Pmachine=lega-public-staging --stacktrace
              gradle :lega-public:removeVolumes -Pmachine=lega-public-staging --stacktrace
            '''
        }
      }
     
    stage('Bootstrap') {
      steps {
          sh '''
            gradle :cega:createConfiguration \
            -Pmachine=cega-staging \
            --stacktrace

            gradle :lega-private:createConfiguration \
            -Pmachine=lega-private-staging \
            --stacktrace

            gradle :lega-public:createConfiguration \
            -Pmachine=lega-public-staging \
            -PcegaIP=${CEGA_IP} \
            -PlegaPrivateIP=${LEGA_private_IP} \
            --stacktrace
          '''
      }
    }

    stage('Deploy') {
      steps {
      parallel(
            "CEGA": {
              sh '''
                gradle :cega:deployStack \
                -Pmachine=cega-staging \
                --stacktrace
                #
                sleep 150
                eval "$(docker-machine env cega-staging)"
                gradle ls
              '''
            },
            "LEGA Public": {
              sh '''
                gradle :lega-public:deployStack \
                -Pmachine=lega-public-staging \
                --stacktrace
                #
                sleep 150
                eval "$(docker-machine env lega-public-staging)"
                gradle ls
              '''
            },
            "LEGA Private": {
              sh '''
                gradle :lega-private:deployStack \
                -Pmachine=lega-private-staging \
                --stacktrace
                #
                sleep 150
                eval "$(docker-machine env lega-private-staging)"
                gradle ls
              '''
            }
          )
      }
    }
    stage('Test') {
      steps {
        sh '''
          gradle ingest \
          -PcegaIP=${CEGA_IP} \
          -PlegaPublicIP=${LEGA_public_IP} \
          -PlegaPrivateIP=${LEGA_private_IP} \
          --stacktrace
        '''
      }
    }
  }
  
  post('Logging') { 
    failure {
        sh '''
          eval "$(docker-machine env lega-public-staging)"
          echo '---=== lega-public-staging_inbox Logs ===---'
          docker service logs lega-public-staging_inbox
          echo '---=== lega-public-staging_mq Logs ===---'
          docker service logs lega-public-staging_mq
        '''
        sh '''
          eval "$(docker-machine env cega-staging)"
          echo '---=== cega-staging_cega-mq Logs ===---'
          docker service logs cega-staging_cega-mq
        '''
        sh '''
          eval "$(docker-machine env lega-private-staging)"
          echo '---=== lega-private-staging-mq Logs ===---'
          docker service logs lega-private-staging_mq
          echo '---=== lega-private-staging_ingest Logs ===---'
          docker service logs lega-private-staging_ingest
          echo '---=== lega-private-staging_inbox-s3 Logs ===---'
          docker service logs lega-private-staging_inbox-s3
          echo '---=== lega-private-staging_vault-s3 Logs ===---'
          docker service logs lega-private-staging_vault-s3
          echo '---=== lega-private-staging_db Logs ===---'
          docker service logs lega-private-staging_db
          echo '---=== lega-private-staging_verify Logs ===---'
          docker service logs lega-private-staging_verify
        '''
        

    }
//   always {
//      sh 'docker-machine rm -y CEGA-${GIT_COMMIT_SHORT} LEGA-public-${GIT_COMMIT_SHORT} LEGA-private-${GIT_COMMIT_SHORT}'
//      sh '''
//        eval "$(docker-machine env CEGA-${GIT_COMMIT_SHORT})"
//        docker swarm leave --force
//        docker-machine rm -y CEGA-${GIT_COMMIT_SHORT}
//        '''
//      sh '''
//        eval "$(docker-machine env LEGA-public-${GIT_COMMIT_SHORT})"
//        docker swarm leave --force
//        docker-machine rm -y  LEGA-public-${GIT_COMMIT_SHORT}
//        '''
//      sh '''
//        eval "$(docker-machine env LEGA-private-${GIT_COMMIT_SHORT})"
//        docker swarm leave --force
//        docker-machine rm -y  LEGA-private-${GIT_COMMIT_SHORT}
//      '''
//   }
  }
  
}
